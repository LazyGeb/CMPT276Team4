/*
 * References:
 * 1. https://www.html5rocks.com/en/tutorials/file/dndfiles/
 *      - Used for reading in files
 * 2. https://blog.teamtreehouse.com/reading-files-using-the-html5-filereader-api
 *      - Used for reading in files
 */
 

let stepBackward = new Array();
var runEmulator = null;
var pauseflag = false;
var loadFlag = null;
var logToggle = false;
function main(usrFile) {
    document.getElementById("runTest").onclick = function () { runTest()};
    document.getElementById("startEmulator").onclick = function () { 
        if (loadFlag != false) {
            startEmulator(usrFile);
            loadFlag = false;
			document.getElementById("startEmulator").classList.add("emulatorRunning");
			if (logToggle) {
				chip.logToggle = true;
			}
        }
    };
	document.getElementById("logToggle").onclick = function () { toggleLog()};
} 

function pushThisChip() {
    if (stepBackward.length > 200) {
        stepBackward.shift();
    }
    let newChip = new Chip8();
    newChip = chip.deepCopy(newChip);
    stepBackward.push(newChip);
}

function callSetInt(){
	runEmulator = 
        setInterval(function() {
            if (chip.getWaitKeyFlag() == true || pauseflag == true) {
                window.clearInterval(runEmulator);
            }
            else {
                chip.runEmulator(); 
            }
        }, 1);
}

function startEmulator(usrFile) {
    chip = new Chip8();
    chip.reset();
	document.getElementById("log").innerHTML = "";
	if (usrFile && !snakeOK && !floppyOK) {
        chip.loadProgram(prog);
    }
    if (snakeOK) {
		//snake program hardcoded.
		chip.program = [0x13, 0x6a, 0xa3, 0x25, 0xd4, 0x51, 0x3f, 0x01, 0x00, 0xee, 0x54, 0x80, 0x12, 0xde, 0x55, 0x90
					  , 0x12, 0xde, 0x60, 0x02, 0xf0, 0x18, 0x22, 0xc6, 0x76, 0x01, 0x22, 0xc6, 0x60, 0xff, 0x61, 0xff
					  , 0x7b, 0xfe, 0xa3, 0x90, 0xfb, 0x1e, 0xf1, 0x55, 0x7b, 0xfe, 0xa3, 0x90, 0xfb, 0x1e, 0xf1, 0x55
					  , 0xa3, 0x25, 0xd4, 0x51, 0x12, 0xa0, 0x00, 0xee, 0x80, 0x70, 0xb2, 0x5a, 0x00, 0xee, 0x60, 0x05
					  , 0xe0, 0xa1, 0x67, 0x00, 0x60, 0x07, 0xe0, 0xa1, 0x67, 0x0c, 0x60, 0x08, 0xe0, 0xa1, 0x67, 0x08
					  , 0x60, 0x09, 0xe0, 0xa1, 0x67, 0x04, 0x00, 0xee, 0x00, 0xee, 0x75, 0xff, 0x00, 0xee, 0x74, 0x01
					  , 0x00, 0xee, 0x75, 0x01, 0x00, 0xee, 0x74, 0xff, 0x00, 0xee, 0x00, 0xee, 0xa3, 0x90, 0x7a, 0x02
					  , 0xfa, 0x1e, 0x80, 0x40, 0x81, 0x50, 0xf1, 0x55, 0x00, 0xee, 0x00, 0xee, 0xa3, 0x90, 0xfb, 0x1e
					  , 0xf1, 0x65, 0xa3, 0x25, 0xd0, 0x11, 0x7b, 0x02, 0x00, 0xee, 0x00, 0xee, 0x44, 0xff, 0x12, 0xde
					  , 0x44, 0x40, 0x12, 0xde, 0x45, 0xff, 0x12, 0xde, 0x45, 0x20, 0x12, 0xde, 0x00, 0xee, 0x00, 0xee
					  , 0xc8, 0x3f, 0xc9, 0x1f, 0x60, 0x07, 0x80, 0x97, 0x3f, 0x00, 0x12, 0xb8, 0x60, 0x36, 0x80, 0x87
					  , 0x3f, 0x01, 0x12, 0xb8, 0x12, 0xa0, 0x00, 0xee, 0xa3, 0x25, 0xd8, 0x91, 0x4f, 0x00, 0x00, 0xee
					  , 0xd8, 0x91, 0x12, 0xa0, 0x00, 0xee, 0xa3, 0x28, 0xf6, 0x33, 0xf2, 0x65, 0x60, 0x37, 0x63, 0x00
					  , 0xf1, 0x29, 0xd0, 0x35, 0x70, 0x05, 0xf2, 0x29, 0xd0, 0x35, 0x00, 0xee, 0x00, 0xee, 0x60, 0x0f
					  , 0xf0, 0x18, 0x22, 0xe8, 0x23, 0x1e, 0x00, 0xee, 0x00, 0xe0, 0x60, 0x0f, 0x61, 0x08, 0xa3, 0x2b
					  , 0xd0, 0x17, 0x70, 0x08, 0xa3, 0x34, 0xd0, 0x17, 0x70, 0x08, 0xa3, 0x3d, 0xd0, 0x17, 0x70, 0x08
					  , 0xa3, 0x46, 0xd0, 0x17, 0x60, 0x0f, 0x71, 0x08, 0xa3, 0x4f, 0xd0, 0x17, 0x70, 0x08, 0xa3, 0x58
					  , 0xd0, 0x17, 0x70, 0x08, 0xa3, 0x46, 0xd0, 0x17, 0x70, 0x08, 0xa3, 0x61, 0xd0, 0x17, 0x13, 0x1e
					  , 0x00, 0xee, 0xe0, 0x00, 0xee, 0x80, 0x00, 0xee, 0xc0, 0x00, 0x00, 0x7e, 0x42, 0x40, 0x66, 0x62
					  , 0x62, 0x7e, 0x00, 0xee, 0x3c, 0x24, 0x24, 0x7e, 0x62, 0x62, 0x62, 0x00, 0xee, 0x7f, 0x49, 0x49
					  , 0x6d, 0x6d, 0x6d, 0x6d, 0x00, 0xee, 0x7e, 0x40, 0x40, 0x7c, 0x60, 0x60, 0x7e, 0x00, 0xee, 0x7e
					  , 0x46, 0x46, 0x42, 0x42, 0x42, 0x7e, 0x00, 0xee, 0x61, 0x61, 0x61, 0x61, 0x23, 0x22, 0x3e, 0x00
					  , 0xee, 0x7e, 0x42, 0x42, 0x7f, 0x61, 0x61, 0x61, 0x00, 0xee, 0x6a, 0x08, 0x6b, 0x04, 0x66, 0x00
					  , 0x67, 0x04, 0xa3, 0x90, 0xfb, 0x1e, 0xf5, 0x65, 0xa3, 0x22, 0xd0, 0x11, 0x22, 0xc6, 0x22, 0xa0
					  , 0x22, 0x3e, 0x22, 0x38, 0x22, 0x8c, 0x22, 0x6c, 0x22, 0x02, 0x22, 0x7c, 0x13, 0x80, 0x00, 0xee
					  , 0x00, 0x00, 0x00, 0x00, 0x0a, 0x0a, 0x0b, 0x0a, 0x0c, 0x0a, 0x00, 0xee ];
		chip.loadProgram(chip.program);
	} else if(floppyOK) {
		//flappy bird hardcoded
		chip.program = [0x13, 0x7F, 0xF0, 0x90, 0xF7, 0x84, 0x84, 0xEE, 0x88, 0xEE, 0x82, 0xEE, 0xE0, 0x80, 0xE0, 0x20
					  , 0xE0, 0x88, 0x88, 0xA8, 0xA8, 0xF8, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
					  , 0x80, 0x80, 0x80, 0x80, 0x80, 0x81, 0x7E, 0x7E, 0x3C, 0x18, 0x18, 0x24, 0x7E, 0x00, 0x00, 0xE0
					  , 0x80, 0xD7, 0x95, 0x95, 0x00, 0x00, 0x00, 0xF0, 0x15, 0xF0, 0x07, 0x30, 0x00, 0x12, 0x39, 0x00
					  , 0xEE, 0x60, 0x0E, 0x61, 0x0A, 0x62, 0x00, 0x63, 0x05, 0xA2, 0x02, 0xD0, 0x15, 0x70, 0x09, 0x42
					  , 0x02, 0x70, 0x04, 0x72, 0x01, 0xF3, 0x1E, 0x42, 0x05, 0x60, 0x12, 0x42, 0x05, 0x71, 0x09, 0x42
					  , 0x06, 0x70, 0x02, 0x32, 0x04, 0x12, 0x4B, 0x00, 0xEE, 0x66, 0x28, 0xC7, 0x03, 0x00, 0xEE, 0x47
					  , 0x00, 0x22, 0x81, 0x47, 0x01, 0x22, 0x8B, 0x47, 0x02, 0x22, 0x95, 0x47, 0x03, 0x22, 0xA3, 0x00
					  , 0xEE, 0x60, 0x04, 0xD6, 0x0F, 0x70, 0x0F, 0xD6, 0x0D, 0x00, 0xEE, 0x60, 0x00, 0xD6, 0x0E, 0x70
					  , 0x12, 0xD6, 0x0E, 0x00, 0xEE, 0x60, 0x00, 0xD6, 0x0A, 0x70, 0x0E, 0xD6, 0x0F, 0x70, 0x0F, 0xD6
					  , 0x03, 0x00, 0xEE, 0x60, 0x00, 0xD6, 0x06, 0x70, 0x0A, 0xD6, 0x0F, 0x70, 0x0F, 0xD6, 0x07, 0x00
					  , 0xEE, 0x6C, 0x00, 0x6E, 0x06, 0x6D, 0x0F, 0xA2, 0x34, 0xFC, 0x33, 0x00, 0xE0, 0x63, 0x30, 0x64
					  , 0x0D, 0xF0, 0x29, 0xD3, 0x45, 0x73, 0x05, 0x33, 0x3F, 0x12, 0xC3, 0x63, 0x2C, 0x64, 0x00, 0xA2
					  , 0x16, 0xD3, 0x42, 0x74, 0x02, 0x34, 0x20, 0x12, 0xD1, 0x22, 0x69, 0x22, 0x6F, 0xDE, 0xD2, 0x00
					  , 0xEE, 0x64, 0x0D, 0x65, 0x00, 0xA2, 0x34, 0xF2, 0x65, 0x63, 0x30, 0xF0, 0x29, 0xD3, 0x45, 0x73
					  , 0x05, 0xF1, 0x29, 0xD3, 0x45, 0x73, 0x05, 0xF2, 0x29, 0xD3, 0x45, 0x75, 0x01, 0xA2, 0x34, 0xFC
					  , 0x33, 0x35, 0x02, 0x12, 0xE7, 0xA2, 0x16, 0x00, 0xEE, 0x00, 0xE0, 0x60, 0x1D, 0x61, 0x05, 0x62
					  , 0x0A, 0xA2, 0x25, 0x4C, 0xFF, 0xD0, 0x1F, 0x3C, 0xFF, 0xF2, 0x1E, 0x3C, 0xFF, 0xD0, 0x15, 0x6E
					  , 0x00, 0x6F, 0x00, 0x6D, 0x00, 0x60, 0x78, 0x22, 0x37, 0xF0, 0x0A, 0x00, 0xE0, 0x00, 0xEE, 0x22
					  , 0x6F, 0x61, 0x02, 0x86, 0x15, 0x22, 0x6F, 0x46, 0x00, 0x22, 0x6F, 0x46, 0x00, 0x22, 0x69, 0x46
					  , 0x28, 0x22, 0x6F, 0xDE, 0xD2, 0x61, 0x05, 0x62, 0x01, 0xE1, 0x9E, 0x8D, 0x24, 0xE1, 0xA1, 0x8D
					  , 0x25, 0xDE, 0xD2, 0x4F, 0x01, 0x23, 0x09, 0x4D, 0x1F, 0x23, 0x09, 0x4D, 0xFF, 0x23, 0x09, 0x4C
					  , 0xFF, 0x23, 0x09, 0x9E, 0x60, 0x7C, 0x01, 0x00, 0xEE, 0x22, 0xB1, 0x89, 0xC0, 0x23, 0x2F, 0x4E
					  , 0x00, 0x00, 0xEE, 0x59, 0xC0, 0x22, 0xE1, 0x60, 0x02, 0x22, 0x37, 0x13, 0x6B, 0x00, 0xEE, 0x22
					  , 0x41, 0x60, 0x08, 0x22, 0x37, 0x63, 0x05, 0xE3, 0xA1, 0x23, 0x69, 0x13, 0x7F, 0x00];
		chip.loadProgram(chip.program);
	}


    callSetInt();
}

    //If click  pause -> clear setinterval
    document.getElementById("pause").onclick = function() {
        if (pauseflag === false) {
            chip.updateHTMLLogMessage("Emulator Paused");

			//for the UI 
			document.getElementById("resume").classList.add("stepControlActive");
			document.getElementById("stepForward").classList.add("stepControlActive");
			document.getElementById("stepBack").classList.add("stepControlActive");
			document.getElementById("resume").classList.remove("stepControlInactive");
			document.getElementById("stepBack").classList.remove("stepControlInactive");
			document.getElementById("stepForward").classList.remove("stepControlInactive");

            pauseflag = true;
		}
    };
    

    //If click  resume -> run emulator is true
	document.getElementById("resume").onclick = function() {
		if (pauseflag == true){
			callSetInt();
    		chip.updateHTMLLogMessage("Emulator Resumed");

			//for the UI
			document.getElementById("resume").classList.remove("stepControlActive");
			document.getElementById("stepForward").classList.remove("stepControlActive");
			document.getElementById("stepBack").classList.remove("stepControlActive");
			document.getElementById("resume").classList.add("stepControlInactive");
			document.getElementById("stepBack").classList.add("stepControlInactive");
			document.getElementById("stepForward").classList.add("stepControlInactive");

			pauseflag = false;
		}
    };

    //If click step forward -> move forward one opcode
    document.getElementById("stepForward").onclick = function() { 
		if (pauseflag === false) return;
		chip.runEmulator();
		chip.updateHTMLLogMessage("Stepped Forward");

    };

    document.getElementById("stepBack").onclick = function() {
		if (pauseflag === false) return;
        window.clearInterval(runEmulator);
        
        chip.updateHTMLLogMessage("Stepped Backwards");
        stepBackward.pop(); //get rid of one (cause we run through one at the end)
        let otherChip = stepBackward.pop();
        console.log(otherChip.register.toString());
        console.log(otherChip.stack.toString());
        console.log(otherChip.programCounter.toString(16));
        this.chip = otherChip.deepCopy(chip);
        pauseflag = true;
        chip.runEmulator(); //run that once (updates emulator every time you step back)
    };

    var translateKeys = {
        49: 1,
        50: 2,
        51: 3,
        52: 12,
        81: 4,
        87: 5,
        69: 6,
        82: 13,
        65: 7,
        83: 8,
        68: 9,
        70: 14,
        90: 10,
        88: 0,
        67: 11,
        86: 15,
    };

    document.addEventListener("keydown", function(event) {
        chip.keydown(translateKeys[event.keyCode]);
        if (chip.getWaitKeyFlag() == true && pauseflag == false) {
            chip.runEmulator();
            callSetInt();
        }
    });

    document.addEventListener("keyup", function(event) {
        chip.keyup(translateKeys[event.keyCode]);
    });



function runTest() {
    opCoTest();
}

function toggleLog() {
	if (!logToggle) {
	//turns on
		logToggle = true;
		if (chip!= null) {
			chip.logToggle = true;
			document.getElementById("logToggle").innerText = "Toggle Log Off";
			document.getElementById("log").innerHTML = "";
			chip.logCount = 0;
		}
	} else {
	//turns off
		logToggle = false;
		if (chip!= null) {
			chip.logToggle = false;
			document.getElementById("logToggle").innerText = "Toggle Log On";
			chip.updateHTMLLogMessage("Click on \"Toggle Log On\" to bring back the logs");
			document.getElementById("log").removeChild(document.getElementById("log").lastElementChild);
		}
	}
}

//function to update game rom name and input to snake or flappy bird when select is chosen
let snakeOK, floppyOK = false;
function updateGameFromSelect() {
	if (snakeOK || floppyOK)window.clearInterval(runEmulator);
	snakeOK = false;
	floppyOK = false;
	var lol = document.getElementById("games");
	if (lol.options[lol.selectedIndex].value !== "default") {
		if (lol.options[lol.selectedIndex].value === "snake") {
			//play snake
			snakeOK = true;
			alert("Snake has been loaded, please press \"Start Emulation\"");
			document.getElementById("fileUploadBox").innerText = "Snake Clone loaded";
		} else {
			//play floppy
			floppyOK = true;
			alert("Flappy Bird has been loaded, please press \"Start Emulation\"");
			document.getElementById("fileUploadBox").innerText = "Flappy Bird Clone loaded";
		}
	}
	loadFlag = true; //makes sure runEmulator only runs once
    pauseflag = false; //resets the pause flag when new game is put in
	document.getElementById("startEmulator").classList.remove("emulatorRunning");
	main(true); //call main, with true boolean to show it should load a file

}


let inputElement = document.getElementById("file");
inputElement.addEventListener("change", handleFiles, false);
let file;
let prog;
function handleFiles() {
    window.clearInterval(runEmulator);
    file = this.files[0];
    let reader = new FileReader();
    let result;
    reader.onload = function(event) {
        result = event.target.result; //result = contents of file
        result = result.replace(/\n/g, " "); //replace any newline characters with spaces
        let arr = result.split(" "); //string to array, split by spaces
        prog = new Uint8Array(arr.length*2); //Array to hold program
        let j = 0;
        for (let i = 0; j <= arr.length; i += 2) { //loop to split opcodes into 1 byte
            prog[i] = (parseInt(arr[j], 16) & 0xFF00) >>> 8; //first byte (parse int --> convert string to int)
            prog[i+1] = (parseInt(arr[j], 16) & 0x00FF);     //second byte
            j++;
        }
        alert("Your file has been loaded, please press \"Start Emulation\"");
        
		//input name
		var fileElement = document.getElementById('file');
		var filename = fileElement.files[0].name;
		document.getElementById("fileUploadBox").innerText = filename + " uploaded";

		loadFlag = true; //makes sure runEmulator only runs once
        pauseflag = false; //resets the pause flag when new game is put in
		document.getElementById("startEmulator").classList.remove("emulatorRunning");
		main(true); //call main, with true boolean to show it should load a file
    };
    reader.readAsBinaryString(file);
}


main(false);

